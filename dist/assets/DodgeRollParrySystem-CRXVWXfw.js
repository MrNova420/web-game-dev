var g=(f,t)=>()=>(t||f((t={exports:{}}).exports,t),t.exports);var d=g((u,c)=>{class l{constructor(t,e,s,i){this.controller=t,this.combat=e,this.audio=s,this.particles=i,this.entityStates=new Map,this.iFrames=new Map,this.parryWindows=new Map,this.config={dodge:{staminaCost:25,cooldown:1e3,iFrameDuration:500,perfectDodgeWindow:150,distance:5,speed:10},parry:{window:300,perfectWindow:100,staminaCost:15,cooldown:2e3,reflectDamagePercent:.5,stunDuration:1500,counterMultiplier:2},stamina:{max:100,regenRate:10,regenDelay:1e3}}}initializeEntity(t,e=100){this.entityStates.set(t,{stamina:e,maxStamina:e,lastStaminaUse:0,lastDodge:0,lastParry:0,isDodging:!1,isParrying:!1,dodgeDirection:null})}update(t){const e=Date.now();for(const[s,i]of this.entityStates.entries())if(e-i.lastStaminaUse>=this.config.stamina.regenDelay&&i.stamina<i.maxStamina){const n=this.config.stamina.regenRate*t/1e3;i.stamina=Math.min(i.maxStamina,i.stamina+n)}for(const[s,i]of this.iFrames.entries())e>i&&this.iFrames.delete(s);for(const[s,i]of this.parryWindows.entries())if(e>i){this.parryWindows.delete(s);const a=this.entityStates.get(s);a&&(a.isParrying=!1)}}dodge(t,e="back"){const s=this.entityStates.get(t);if(!s)return this.initializeEntity(t),this.dodge(t,e);const i=Date.now();if(i-s.lastDodge<this.config.dodge.cooldown)return{success:!1,reason:"cooldown"};if(!this.canDodge(t))return{success:!1,reason:"disabled"};const a=this.checkPerfectDodgeTiming(t);if(!a&&s.stamina<this.config.dodge.staminaCost)return{success:!1,reason:"no_stamina"};a||(s.stamina-=this.config.dodge.staminaCost,s.lastStaminaUse=i),s.lastDodge=i,s.isDodging=!0,s.dodgeDirection=e;const n=a?this.config.dodge.iFrameDuration*1.5:this.config.dodge.iFrameDuration;return this.iFrames.set(t,i+n),this.performDodgeMovement(t,e),this.showDodgeEffect(t,e,a),setTimeout(()=>{s.isDodging=!1},500),{success:!0,isPerfect:a,stamina:s.stamina,iFrameDuration:n}}parry(t,e,s){const i=this.entityStates.get(t);if(!i)return this.initializeEntity(t),this.parry(t,e,s);const a=Date.now();if(a-i.lastParry<this.config.parry.cooldown)return{success:!1,reason:"cooldown"};if(!this.canParry(t))return{success:!1,reason:"disabled"};if(i.stamina<this.config.parry.staminaCost)return{success:!1,reason:"no_stamina"};const n=this.parryWindows.get(t);if(!n||a>n)return{success:!1,reason:"no_parry_window"};i.stamina-=this.config.parry.staminaCost,i.lastStaminaUse=a,i.lastParry=a;const r=n-a>=this.config.parry.window-this.config.parry.perfectWindow,h=Math.floor(s*this.config.parry.reflectDamagePercent);return r&&(this.combat?.takeDamage(e,h,{type:"reflected",source:t}),this.combat?.applyStatusEffect(e,"stun",this.config.parry.stunDuration),this.enableCounterattack(t,e)),this.showParryEffect(t,e,r),this.parryWindows.delete(t),i.isParrying=!1,{success:!0,isPerfect:r,reflectedDamage:h,stunned:r,stamina:i.stamina}}startParryWindow(t){const e=this.entityStates.get(t);if(!e)return!1;const s=Date.now();return s-e.lastParry<this.config.parry.cooldown?!1:(this.parryWindows.set(t,s+this.config.parry.window),e.isParrying=!0,this.showParryWindow(t),!0)}enableCounterattack(t,e){this.combat&&(setTimeout(()=>{},1e3),this.audio?.playSFX("counter_ready",1))}performDodgeMovement(t,e){const s=this.config.dodge.distance,i=this.getEntityPosition(t),a=this.getEntityFacing(t);let n=i.x,o=i.z;switch(e){case"forward":n+=Math.cos(a)*s,o+=Math.sin(a)*s;break;case"back":n-=Math.cos(a)*s,o-=Math.sin(a)*s;break;case"left":n+=Math.cos(a-Math.PI/2)*s,o+=Math.sin(a-Math.PI/2)*s;break;case"right":n+=Math.cos(a+Math.PI/2)*s,o+=Math.sin(a+Math.PI/2)*s;break}this.controller?.moveEntity(t,{x:n,y:i.y,z:o},this.config.dodge.speed)}checkPerfectDodgeTiming(t){return!1}canDodge(t){return!this.combat?.hasStatusEffect(t,"stun")&&!this.combat?.hasStatusEffect(t,"freeze")}canParry(t){return!this.combat?.hasStatusEffect(t,"stun")&&!this.combat?.hasStatusEffect(t,"freeze")&&!this.combat?.hasStatusEffect(t,"confusion")}hasIFrames(t){const e=this.iFrames.get(t);return e&&Date.now()<e}getStamina(t){const e=this.entityStates.get(t);return e?e.stamina:0}setStamina(t,e){const s=this.entityStates.get(t);s&&(s.stamina=Math.max(0,Math.min(s.maxStamina,e)))}showDodgeEffect(t,e,s){const i=this.getEntityPosition(t);this.particles?.createEffect("dodge_trail",i,{direction:e,color:s?"#FFD700":"#FFFFFF"});const a=s?"dodge_perfect":"dodge";this.audio?.playSFX(a,1),s&&this.audio?.playSFX("perfect_timing",.7)}showParryEffect(t,e,s){const i=this.getEntityPosition(t);this.getEntityPosition(e),this.particles?.createEffect("parry_spark",i,{color:s?"#FFD700":"#FFFFFF",intensity:s?2:1});const a=s?"parry_perfect":"parry";this.audio?.playSFX(a,1),s&&this.audio?.playSFX("perfect_timing",.7)}showParryWindow(t){const e=this.getEntityPosition(t);this.particles?.createEffect("parry_ready",e,{duration:this.config.parry.window})}getEntityPosition(t){return this.controller?.getEntityPosition?.(t)||{x:0,y:0,z:0}}getEntityFacing(t){return this.controller?.getEntityFacing?.(t)||0}}typeof c<"u"&&c.exports&&(c.exports=l)});export default d();
