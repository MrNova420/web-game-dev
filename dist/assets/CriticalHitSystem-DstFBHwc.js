var M=(f,t)=>()=>(t||f((t={exports:{}}).exports,t),t.exports);var S=M((F,u)=>{class p{constructor(t,e,s,i,r){this.combat=t,this.camera=e,this.ui=s,this.audio=i,this.particles=r,this.baseCritChance=.05,this.baseCritMultiplier=1.5,this.critModifiers=new Map,this.critStreaks=new Map,this.nonCritCounters=new Map,this.critStats=new Map,this.critTypes={normal:{name:"Critical Hit",multiplier:1.5,color:"#FFFF00",chance:.7},strong:{name:"Strong Critical",multiplier:2,color:"#FF8800",chance:.2},deadly:{name:"Deadly Critical",multiplier:2.5,color:"#FF4400",chance:.08},legendary:{name:"Legendary Critical",multiplier:3,color:"#FF0000",chance:.02}}}calculateCritical(t,e,s={}){const{isBackstab:i=!1,isHeadshot:r=!1,targetId:n=null,ignoreModifiers:a=!1}=s;let o=this.baseCritChance;if(!a){const m=this.getCritModifiers(t);o+=m.critChanceBonus}const c=this.nonCritCounters.get(t)||0;if(c>=20&&(o=1),!(Math.random()<o))return this.nonCritCounters.set(t,c+1),this.resetCritStreak(t),{isCritical:!1,damage:e,multiplier:1};const C=this.determineCritType();let l=C.multiplier;if(!a){const m=this.getCritModifiers(t);l*=m.critDamageMult}i&&(l*=2),r&&(l*=2.5);const g=Math.floor(e*l);return this.nonCritCounters.set(t,0),this.incrementCritStreak(t),this.updateCritStats(t,C.name,g),this.showCriticalHit(t,n,g,C,i,r),{isCritical:!0,type:C.name,damage:g,multiplier:l,isBackstab:i,isHeadshot:r,streak:this.getCritStreak(t)}}determineCritType(){const t=Math.random();let e=0;const s=Object.values(this.critTypes).reverse();for(const i of s)if(e+=i.chance,t<e)return i;return this.critTypes.normal}checkBackstab(t,e){const s=this.getEntityPosition(t),i=this.getEntityPosition(e),r=this.getEntityFacing(e);if(!s||!i||!r)return!1;const n=s.x-i.x,a=s.z-i.z,o=Math.atan2(a,n),h=(Math.abs(o-r)+Math.PI)%(Math.PI*2)-Math.PI;return Math.abs(h)>2*Math.PI/3}checkHeadshot(t,e,s){const i=this.getEntityPosition(e);if(!i||!s)return!1;const r=s.y-i.y;return r>=1.5&&r<=2}setCritModifiers(t,e={}){this.critModifiers.set(t,{critChanceBonus:e.critChanceBonus||0,critDamageMult:e.critDamageMult||1})}getCritModifiers(t){return this.critModifiers.get(t)||{critChanceBonus:0,critDamageMult:1}}addCritChanceBonus(t,e){const s=this.getCritModifiers(t);s.critChanceBonus+=e,this.critModifiers.set(t,s)}addCritDamageMultiplier(t,e){const s=this.getCritModifiers(t);s.critDamageMult*=e,this.critModifiers.set(t,s)}incrementCritStreak(t){const e=this.critStreaks.get(t)||0;this.critStreaks.set(t,e+1)}resetCritStreak(t){this.critStreaks.set(t,0)}getCritStreak(t){return this.critStreaks.get(t)||0}updateCritStats(t,e,s){this.critStats.has(t)||this.critStats.set(t,{totalCrits:0,critsByType:{},totalCritDamage:0,highestCrit:0,longestStreak:0});const i=this.critStats.get(t);i.totalCrits++,i.critsByType[e]=(i.critsByType[e]||0)+1,i.totalCritDamage+=s,i.highestCrit=Math.max(i.highestCrit,s),i.longestStreak=Math.max(i.longestStreak,this.getCritStreak(t))}getCritStats(t){return this.critStats.get(t)||{totalCrits:0,critsByType:{},totalCritDamage:0,highestCrit:0,longestStreak:0}}showCriticalHit(t,e,s,i,r,n){const a=this.getEntityPosition(e);this.ui?.showDamageNumber(a,s,{type:"critical",critType:i.name,color:i.color,scale:1.5+(i.multiplier-1.5)*.5,isBackstab:r,isHeadshot:n}),this.particles?.createEffect("critical_hit",a,{color:i.color,intensity:i.multiplier});const o=.1*i.multiplier;this.camera?.shake(o,.3);const c=i.multiplier>=2.5?"crit_massive":"crit_normal";this.audio?.playSFX(c,1);const h=this.getCritStreak(t);h>=3&&this.ui?.showNotification(`${h}x Critical Streak!`,"achievement")}getEntityPosition(t){return this.combat?.getEntityPosition?.(t)||{x:0,y:0,z:0}}getEntityFacing(t){return this.combat?.getEntityFacing?.(t)||0}}typeof u<"u"&&u.exports&&(u.exports=p)});export default S();
