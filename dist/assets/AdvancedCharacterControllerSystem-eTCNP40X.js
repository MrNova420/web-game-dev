import{V as a,aU as l,O as h,a3 as d,a_ as u,a$ as y}from"./three-DTQjiZ7L.js";class f{constructor(t,i){this.scene=t,this.camera=i,this.characters=new Map,this.playerCharacter=null,this.keys={},this.mousePosition={x:0,y:0},this.settings={walkSpeed:5,runSpeed:10,sprintSpeed:15,jumpForce:8,gravity:-20,rotationSpeed:5,smoothing:.1},this.setupInputHandlers()}setupInputHandlers(){window.addEventListener("keydown",t=>{this.keys[t.key.toLowerCase()]=!0,t.key===" "&&this.playerCharacter&&this.jump(this.playerCharacter.id)}),window.addEventListener("keyup",t=>{this.keys[t.key.toLowerCase()]=!1}),window.addEventListener("mousemove",t=>{this.mousePosition.x=t.clientX/window.innerWidth*2-1,this.mousePosition.y=-(t.clientY/window.innerHeight)*2+1})}registerCharacter(t,i,e={}){const s={id:t,model:i,animations:{},mixer:null,currentAction:null,state:"idle",velocity:new a,isGrounded:!0,isPlayer:!1,stats:{speed:this.settings.walkSpeed,jumpHeight:this.settings.jumpForce}};if(e&&Object.keys(e).length>0){s.mixer=new l(i);for(const[o,n]of Object.entries(e))s.animations[o]=s.mixer.clipAction(n);s.animations.idle&&(s.currentAction=s.animations.idle,s.currentAction.play())}return this.characters.set(t,s),s}setPlayerCharacter(t){const i=this.characters.get(t);i&&(i.isPlayer=!0,this.playerCharacter=i)}update(t){for(const[i,e]of this.characters.entries())e.isPlayer&&this.updatePlayerMovement(e,t),e.mixer&&e.mixer.update(t),e.isGrounded||(e.velocity.y+=this.settings.gravity*t),e.model.position.add(e.velocity.clone().multiplyScalar(t)),e.model.position.y<=0?(e.model.position.y=0,e.velocity.y=0,e.isGrounded=!0):e.isGrounded=!1}updatePlayerMovement(t,i){const e=this.getMoveSpeed(t),s=new a,o=new a;this.camera.getWorldDirection(o),o.y=0,o.normalize();const n=new a;n.crossVectors(o,h.DefaultUp).normalize();let r=!1;if((this.keys.w||this.keys.arrowup)&&(s.add(o),r=!0),(this.keys.s||this.keys.arrowdown)&&(s.sub(o),r=!0),(this.keys.a||this.keys.arrowleft)&&(s.sub(n),r=!0),(this.keys.d||this.keys.arrowright)&&(s.add(n),r=!0),s.length()>0){s.normalize(),t.velocity.x=s.x*e,t.velocity.z=s.z*e;const c=Math.atan2(s.x,s.z);t.model.rotation.y=d.lerp(t.model.rotation.y,c,this.settings.smoothing)}else t.velocity.x*=.9,t.velocity.z*=.9;this.updateAnimationState(t,r)}getMoveSpeed(t){return this.keys.shift?this.settings.sprintSpeed:this.keys.control?this.settings.walkSpeed*.5:this.settings.runSpeed}updateAnimationState(t,i){let e="idle";t.isGrounded?i&&(this.keys.shift?e="sprint":this.keys.control?e="sneak":e="run"):e=t.velocity.y>0?"jump":"fall",e!==t.state&&(this.transitionAnimation(t,e),t.state=e)}transitionAnimation(t,i){const e=t.animations[i];e&&(t.currentAction&&t.currentAction.fadeOut(.2),e.reset(),e.fadeIn(.2),e.play(),t.currentAction=e)}jump(t){const i=this.characters.get(t);i&&i.isGrounded&&(i.velocity.y=i.stats.jumpHeight,i.isGrounded=!1)}moveToPosition(t,i,e=null){const s=this.characters.get(t);if(!s)return;const o=e||s.stats.speed,n=new a().subVectors(i,s.model.position).normalize();s.velocity.x=n.x*o,s.velocity.z=n.z*o;const r=Math.atan2(n.x,n.z);s.model.rotation.y=r}playAnimation(t,i,e=!0){const s=this.characters.get(t);if(!s||!s.animations[i])return;const o=s.animations[i];o.reset(),o.setLoop(e?u:y),o.play(),s.currentAction=o}getPosition(t){const i=this.characters.get(t);return i?i.model.position.clone():null}setPosition(t,i){const e=this.characters.get(t);e&&e.model.position.set(i.x,i.y,i.z)}getRotation(t){const i=this.characters.get(t);return i?i.model.rotation.y:0}setRotation(t,i){const e=this.characters.get(t);e&&(e.model.rotation.y=i)}removeCharacter(t){const i=this.characters.get(t);i&&(i.mixer&&i.mixer.stopAllAction(),this.characters.delete(t))}getAllPositions(){const t={};for(const[i,e]of this.characters.entries())t[i]=e.model.position.clone();return t}}export{f as AdvancedCharacterControllerSystem};
